--[[
    init.lua
    Created: 12/27/2022 15:08:18
    Description: Autogenerated script file for the map treasuretowncrossroads.
]]--
-- Commonly included lua functions and data
require 'what_does_n_stand_for.common'

-- Package name
local treasuretowncrossroads = {}

-- Local, localized strings table
-- Use this to display the named strings you added in the strings files for the map!
-- Ex:
--      local localizedstring = STRINGS.MapStrings['SomeStringName']


-------------------------------
-- Map Callbacks
-------------------------------
---treasuretowncrossroads.Init
--Engine callback function
function treasuretowncrossroads.Init(map)

  --This will fill the localized strings table automatically based on the locale the game is 
  -- currently in. You can use the MapStrings table after this line!
  

end

---treasuretowncrossroads.Enter
--Engine callback function
function treasuretowncrossroads.Enter(map)
treasuretowncrossroads.chapterhidescript()
SV.branchwaywoodsentrance.DungeonComplete = false

if SV.chapter.number == 0 then
SV.checkpoint = 
  {
    Zone    = 'treasuretownzone', Segment  = -1,
    Map  = 0, Entry  = 0
  } --T.Town entrance, don't call after prologue is done. / Spawns player OOB.
elseif SV.chapter.number == 1 then
SV.checkpoint = 
  {
    Zone    = 'treasuretownzone', Segment  = -1,
    Map  = 17, Entry  = 0
  } --Mess Hall, spawn here after the prologue is done, but not when chapter 2 starts.
  elseif SV.chapter.number == 2 then
SV.checkpoint = 
  {
    Zone    = 'treasuretownzone', Segment  = -1,
    Map  = 9, Entry  = 0
  }
end

if SV.prologue.dont_cutscene then
treasuretowncrossroads.FirstTimeCutscene(alpha)
end

if SV.prologue.reached_main_cutscene then
treasuretowncrossroads.maincutscene(quoteunquote)
end

	if SV.prologue.has_spindas_shaker then
		if SV.prologue.crossroads_cs1 == false then
			treasuretowncrossroads.bumpcutscene(beta)
		end
	end

	if SV.prologue.spindas_shaker_given then
		if SV.prologue.crossroads_cs2 == false then
		treasuretowncrossroads.drenchedbluffintro(gamma)
		end
	end

if SV.dungeons.drenchedbluff_fail then
	if SV.chapter.number == 0 then
		treasuretowncrossroads.DrenchedFailure_Ouch(TryAgain)
	end
end

		COMMON.WeatherApply()
		
		GAME:FadeIn(20) --If all else fails, fade the game in.
		
	end


---treasuretowncrossroads.Exit
--Engine callback function
function treasuretowncrossroads.Exit(map)


end

---treasuretowncrossroads.Update
--Engine callback function
function treasuretowncrossroads.Update(map)


end

---treasuretowncrossroads.GameSave
--Engine callback function
function treasuretowncrossroads.GameSave(map)


end

---treasuretowncrossroads.GameLoad
--Engine callback function
function treasuretowncrossroads.GameLoad(map)

  GAME:FadeIn(20)

end

-------------------------------
-- Entities Callbacks
-------------------------------

function treasuretowncrossroads.SpindaCafeStairs_Touch(obj, activator)

			GAME:FadeOut(false, 20)
			GAME:EnterGroundMap("spindacafe", "Entrance")
			
end

function treasuretowncrossroads.SpindaCafeSign_Action(obj, activator)

  UI:ResetSpeaker()
  UI:SetCenter(true)
  UI:SetAutoFinish(true)
  UI:WaitShowDialogue("Spinda's Café!~ \nServing drinks, and food. Welcomes all!~")
  UI:WaitShowDialogue("(Please bring your own ingredients, or Poké.)")
  
  UI:SetCenter(false)
  UI:SetAutoFinish(false)

end

function treasuretowncrossroads.GuildTravel_Touch(obj, activator)

	if SV.prologue.cant_do_that_yet then
	
local player = CH('PLAYER')

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Stunned")
UI:WaitShowDialogue("(Ahm... [pause=20]Maybe later. [pause=0]Too much stairs to climb up right now.)")

else

GAME:FadeOut(false, 20)
GAME:EnterGroundMap("wigglyguildent", "Entrance")

	end
end

function treasuretowncrossroads.InteractiveNearby_Touch(obj, activator)

SOUND:PlayBattleSE("EVT_Emote_Confused")
    GROUND:CharSetEmote(activator, "question", 1)

end

function treasuretowncrossroads.WaterFountain_Action(obj, activator)

local player = CH('PLAYER')

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Normal")
UI:WaitShowDialogue("(It's a calming pool of water, [pause=10]practically untouched by leaves. [pause=0]I wonder why it's here?)")

end

function treasuretowncrossroads.LeaveTown_Touch(obj, activator)
local player = CH('PLAYER')

	if SV.prologue.cant_do_that_yet == true then

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Angry")
UI:WaitShowDialogue("(I'm not ready yet, [pause=10]I have nothing for the trip to the next town!)")

	elseif SV.chapter.number == 1 and not SV.chapter1.mission_brief then
	UI:SetSpeaker(player)
	UI:SetSpeakerEmotion("Angry")
	UI:WaitShowDialogue("(I can't just leave yet! [pause=0]Someone wants me to do something first!)")
	
	elseif SV.chapter.number == 1 and SV.chapter1.meeting_partA and not SV.chapter1.meeting_partB then
	
	UI:SetSpeaker(player)
	UI:SetSpeakerEmotion("Worried")
	UI:WaitShowDialogue("(Uh, [pause=10]shouldn't I report something to Team [color=#ffb5fd]Electrater[color] before I wander off to [color=#00FFFF]Arceus[color] knows where...?)")
	
	elseif SV.chapter.number == 1 and SV.chapter1.meeting_partB then
	local Madilyn = CH('Madilyn')
	
	SOUND:PlayBattleSE("EVT_Emote_Confused")
    GROUND:CharSetEmote(Madilyn, "question", 1)
	GROUND:CharTurnToCharAnimated(Madilyn, player, 4)
	
	GAME:WaitFrames(40)
	
	UI:SetSpeaker(Madilyn)
	UI:SetSpeakerEmotion("Normal")
	UI:WaitShowDialogue("I know you're eager, [pause=10]but hold on a minute.")
	
	treasuretowncrossroads.Madilyn_Action(chara, activator) --Leaving this way causes the game to hang, sending you to the dungeon, and stop working.
	
	GROUND:MoveInDirection(player, Direction.Left, 10, false, 1)
	GROUND:CharAnimateTurnTo(Madilyn, Direction.Left, 4)
	
	else

   --Enable debugging this coroutine
  local dungeon_entrances = { 'drenchedbluff', 'mossyoutcroppings', 'seasideserenade', 'cacklingquarry', 'roadwalkpathway'} --add more later.
  local ground_entrances = { } --I have no idea how to add MapRoam to this thing. / Or any Groundmap for that matter.

 COMMON.ShowDestinationMenu(dungeon_entrances, ground_entrances)

	end
end

function treasuretowncrossroads.Assembly_Action(obj, activator)

if SV.chapter.number == 0 then
local player = CH('PLAYER')

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("(I shouldn't touch this. [pause=0]It looks like it's for someone else...)")

	else
	--import Assembly script from Base Town, Luminous Springs, whatever, then add dialogue for it before giving a choice. Make the PC unable to be swapped out until Story Mode is over.
		
		UI:ResetSpeaker()
		COMMON.ShowTeamAssemblyMenu(obj, COMMON.RespawnAllies)
	
	end
end

function treasuretowncrossroads.BeachEntrance_Touch(obj, activator)

if SV.prologue.cant_do_that_yet then
local player = CH('PLAYER')

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Pain")
UI:WaitShowDialogue("(Maybe some other time. [pause=0]I have work to do.)")

	else
	
		GAME:FadeOut(false, 20)
		GAME:EnterGroundMap("treasuretownbeachpath", "Entrance")
	
	end
end

function treasuretowncrossroads.Sign_Action(obj, activator)

  UI:ResetSpeaker()
  UI:SetCenter(true)
  UI:SetAutoFinish(true)
  UI:WaitShowDialogue("[color=#FFC663]Wigglytuff's Guild[color] ^ \n <-- [color=#FFC663]Treasure Town[color]")
  UI:SetCenter(false)
  UI:SetAutoFinish(false)
  
end

function treasuretowncrossroads.InteractiveFar_Touch(obj, activator)

	SOUND:PlayBattleSE("EVT_Emote_Exclaim_2")
    GROUND:CharSetEmote(activator, "exclaim", 1)

end

function treasuretowncrossroads.WindThing_Action(obj, activator)
local player = CH('PLAYER')

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("(It... [pause=20]does something. [pause=0]I'm not entirely sure what they do...)")

end

function treasuretowncrossroads.TreasureTownEnter_Touch(obj, activator)

GAME:FadeOut(false, 20)
GAME:EnterGroundMap("treasuretown2", "EntranceRight")

end

function treasuretowncrossroads.MapRoamSign_Action(obj, activator)

	UI:ResetSpeaker()
	UI:SetSpeakerEmotion("Normal")
	UI:ChoiceMenuYesNo(STRINGS:Format(STRINGS.MapStrings['MapRoamString']), false)
	UI:WaitForChoice()
	ch = UI:ChoiceResult()
if ch then
	GAME:FadeOut(true, 30)
	GAME:WaitFrames(30)
    GAME:EnterGroundMap("skyregionmap", "Entrance")
	else
	end
end

function treasuretowncrossroads.FirstTimeCutscene(alpha)

GROUND:Hide("LeaveTown") --Necessary! CutsceneMode does NOT skip activating stuff when walking over them! Various Examples include leaving the map, reloading scripts, and entering back in. Changing it to not hide and trigger it would be a big waste of time. (results would equal the same)
	local player = CH('PLAYER')

  GAME:CutsceneMode(true)
  GAME:WaitFrames(60)
  GAME:FadeIn(20)

	GROUND:MoveInDirection(player, Direction.Left, 50, true, 1)
	GAME:WaitFrames(20)
	
	UI:SetSpeaker(player)
	UI:SetSpeakerLoc(264,131)
	UI:SetSpeakerEmotion("Pain", true)
	UI:WaitShowDialogue("(Oouch... [pause=0]I don't think I should've pushed myself that much...)")
	UI:WaitShowDialogue("(Now I'm sore on every part of my body.)")
	UI:WaitShowDialogue("(Guess I should see if there's something to eat or drink in this town...)")
	UI:SetSpeakerEmotion("Worried", true)
	UI:WaitShowDialogue("(A place to stay for a night also sounds great...)")
	
		GAME:WaitFrames(60)
	
	GAME:CutsceneMode(false)
	
	SOUND:PlaySE("Fanfare/Note")
	
	UI:ResetSpeaker()
	UI:SetSpeakerEmotion("Normal")
	UI:SetCenter(true)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['AdviceBulletin2']))
	UI:SetCenter(false)
	UI:WaitShowDialogue("Bigger objects can be examined as well, and will appear as an Exclaimation Mark over your head.") --dialogue changed because Pass-Through Action objects trigger it's action without an A Press, can't interact underneath. / Or so I f---ing thought
	
	SOUND:PlayBattleSE("EVT_Emote_Exclaim_2")
    GROUND:CharSetEmote(player, "exclaim", 1)
	GAME:WaitFrames(20)
	
	UI:WaitShowDialogue("It can also help look at farther away things you won't be able to see.")
	UI:WaitShowDialogue("And remember, double-check your surroundings. There might be secrets hiding you might not know about.")
	
	SV.prologue.dont_cutscene = false
	GROUND:Unhide("LeaveTown")

end

function treasuretowncrossroads.bumpcutscene(beta)
local player = CH('PLAYER')
local AdamMudkip = CH('AdamMudkip')

GROUND:Unhide('AdamMudkip')

GAME:CutsceneMode(true)

--GROUND:CreateCharacter(mudkip,mudkip,072,192,'yes','yes') --I would really not want to use this to create Characters with Formed Instances (ie Madilyn) / Yeah f*** that, I'm not messing with this. / Not ideal for characters with different forms, and colored names.

local coro1 = TASK:BranchCoroutine(function() treasuretowncrossroads.BumpIntoEachother_Sequence(player) end)
local coro2 = TASK:BranchCoroutine(function() treasuretowncrossroads.BumpIntoEachother_Sequence(AdamMudkip) end)
local coro3 = TASK:BranchCoroutine(function() GAME:FadeIn(25) end)

TASK:JoinCoroutines({coro1,coro2})

SOUND:PlaySE("Battle/EVT_CH02_Box_Open")

GROUND:AnimateInDirection(AdamMudkip, "Idle", Direction.Left, Direction.Right, 15, 3, 2)

if not SV.prologue_alts.learned_adams_name then
	UI:SetSpeaker(STRINGS:Format("\\uE040"), true, AdamMudkip.CurrentForm.Species, AdamMudkip.CurrentForm.Form, AdamMudkip.CurrentForm.Skin, AdamMudkip.CurrentForm.Gender)
	else
	UI:SetSpeaker(AdamMudkip)
end

UI:SetSpeakerEmotion("Stunned")
UI:WaitShowDialogue("Oops, [pause=10]sorry. [pause=0]I was heading home.")

if SV.prologue_alts.talked_to_adam_at_cafe >= 1 then --Booleans are not numbers.

UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("Oh, [pause=10]hey. [pause=0]It's you... [pause=20]I never got your name, [pause=10]but I guess you got somewhere to be if you're leaving.")
UI:SetSpeakerEmotion("Normal")
UI:WaitShowDialogue("Stay safe out there.")

end

GROUND:MoveInDirection(AdamMudkip, Direction.UpLeft, 25, false, 1)
GROUND:EntTurn(player, Direction.UpRight)
GROUND:MoveInDirection(AdamMudkip, Direction.Left, 10, false, 1)
GROUND:EntTurn(player, Direction.Up)
GROUND:MoveInDirection(AdamMudkip, Direction.Left, 30, false, 1)
GROUND:EntTurn(player, Direction.UpLeft)
GROUND:MoveInDirection(AdamMudkip, Direction.Left, 30, false, 1)
GROUND:EntTurn(player, Direction.Left)
GROUND:MoveInDirection(AdamMudkip, Direction.Left, 30, false, 1) --Probably a better way of doing this. Too bad.

GAME:WaitFrames(20)

GROUND:CharSetEmote(player, "sweatdrop", 1)
SOUND:PlayBattleSE("EVT_Emote_Sweatdrop")

GAME:WaitFrames(40)

GROUND:CharAnimateTurn(player, Direction.Right, 4, true)

GAME:WaitFrames(20)

SV.prologue.crossroads_cs1 = true

GAME:CutsceneMode(false)

end

function treasuretowncrossroads.drenchedbluffintro(gamma)
local player = CH('PLAYER')
local AdamMudkip = CH('AdamMudkip')
local Piks = CH('Piks')

GAME:CutsceneMode(true)
SOUND:PlayBGM("None", true)
GROUND:Unhide('AdamMudkip') --No need to hide Piks, he's already outside the map away from the player's view.

GROUND:MoveInDirection(AdamMudkip, Direction.Left, 45, true, 2)

GAME:FadeIn(20)

GROUND:MoveInDirection(player, Direction.Up, 10, true, 1)

	SOUND:PlayBattleSE("EVT_Emote_Exclaim_2")
    GROUND:CharSetEmote(player, "exclaim", 1)

UI:SetSpeaker(STRINGS:Format("\\uE040"), true)
UI:SetSpeakerEmotion("Normal")
UI:WaitShowDialogue("Come on, [pause=10]this way!")

	GROUND:CharAnimateTurn(player, Direction.Left, 4, true)

local coro1 = TASK:BranchCoroutine(function() treasuretowncrossroads.ElectraterWalkIn_Sequence(AdamMudkip) end)
local coro2 = TASK:BranchCoroutine(function() treasuretowncrossroads.ElectraterWalkIn_Sequence(Piks) end)

TASK:JoinCoroutines({coro1,coro2})

UI:SetSpeaker(STRINGS:Format("\\uE040"), true, Piks.CurrentForm.Species, Piks.CurrentForm.Form, Piks.CurrentForm.Skin, Piks.CurrentForm.Gender) --Player will never learn of his name before hand, so he has no SV. Yes, Adam says it in the Café, but a reasonable person wouldn't know who's named that at first.
UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("W-wait, [pause=10]hold on [color=#54ebaf]Adam[color]. [pause=0]What's with this sudden urgency?")
GROUND:CharAnimateTurn(AdamMudkip, Direction.Left, 4, true)
UI:WaitShowDialogue("All of a sudden, [pause=10]you just stared blankly and shot up from our conversation.")
UI:WaitShowDialogue("What's wrong?")

SOUND:PlayBattleSE("EVT_Emote_Sweating")
GROUND:CharSetEmote(AdamMudkip, "sweating", 1)

GAME:WaitFrames(40)

UI:SetSpeaker(AdamMudkip)
UI:SetSpeakerEmotion("Worried", true)
UI:WaitShowDialogue("Yeah, [pause=10]uhm... [pause=20]about that, [pause=10][color=#54ebaf]Piks[color]...")
UI:WaitShowDialogue("Do you remember the...")

GROUND:CharAnimateTurn(AdamMudkip, Direction.Right, 4, false)
GAME:WaitFrames(20)
GROUND:CharAnimateTurn(AdamMudkip, Direction.Up, 4, true)
GAME:WaitFrames(20)
GROUND:CharAnimateTurn(AdamMudkip, Direction.Down, 4, true)
GAME:WaitFrames(20)
GROUND:CharAnimateTurn(AdamMudkip, Direction.Left, 4, false)
GAME:WaitFrames(20)

UI:WaitShowDialogue("*whisper* *whisper* *whisper*...")

GAME:WaitFrames(20)

UI:SetSpeaker(Piks)
UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("That's pretty weird... [pause=20]And it just started working again?")

GAME:WaitFrames(10)

UI:SetSpeaker(AdamMudkip)
UI:SetSpeakerEmotion("Pain", true)
UI:WaitShowDialogue("Mhm... [pause=20]I thought it would never happen again...")
UI:SetSpeakerEmotion("Determined", true)
UI:WaitShowDialogue("But [color=#54ebaf]Madilyn[color] fainted at [color=#FFC663]Drenched Bluff[color], [pause=10]I'm sure of it!")
UI:WaitShowDialogue("She couldn't have fainted in an easy place like that!")

		GROUND:CharSetAnim(Piks, "Hop", false) --unless I find a better 'hopping' animation, this'll have to do.
		SOUND:PlayBattleSE("EVT_Emote_Complain_2")
		GROUND:CharSetEmote(Piks, "angry", 0)
		
		GAME:WaitFrames(30)
		
UI:SetSpeaker(Piks)
UI:SetSpeakerEmotion("Angry")
UI:WaitShowDialogue("We have to investigate! [pause=0]Something's not right!")

local coro1 = TASK:BranchCoroutine(function() treasuretowncrossroads.ElectraterWalkIn2_Sequence(AdamMudkip) end)
local coro2 = TASK:BranchCoroutine(function() treasuretowncrossroads.ElectraterWalkIn2_Sequence(Piks) end)
local coro3 = TASK:BranchCoroutine(function() treasuretowncrossroads.PlayerTurn_Sequence(player) end)

TASK:JoinCoroutines({coro1,coro2,coro3})

--There were mutliple instances of a coroutine here but I deleted them to make this easier to look at.

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("(Gee, [pause=10]they were quick to head out of town.)")
UI:WaitShowDialogue("(They're going to [color=#FFC663]Drenched Bluff[color], [pause=10]too.)")
UI:WaitShowDialogue("(I'm not sure who this '[color=#54ebaf]Madilyn[color]' is, [pause=10]but they seemed really concerned for her.)")
UI:SetSpeakerEmotion("Determined")
UI:WaitShowDialogue("(I should help them too. [pause=0]I can't sit around and do nothing!)")
UI:WaitShowDialogue("(I know where the dungeon is, [pause=10]I can get there quickly.)")

SV.prologue.cant_do_that_yet = false --removes restrictions of Treasure Town.
SV.prologue.crossroads_cs2 = true
SV.dungeons.mpr_drenched = true

GAME:UnlockDungeon('drenchedbluff')
  SOUND:PlayBGM("Treasure Town.ogg", true)

GAME:CutsceneMode(false)

end

function treasuretowncrossroads.DrenchedFailure_Ouch(TryAgain)
local player = CH('PLAYER')
GROUND:Hide('LeaveTown')
GAME:FadeIn(20)
GAME:CutsceneMode(true)
GROUND:MoveInDirection(player, Direction.Left, 80, false, 2)

GAME:WaitFrames(30)

UI:SetSpeaker(player)
UI:SetSpeakerEmotion("Pain")
UI:WaitShowDialogue("(Agh, [pause=10]I didn't play my best hand there...)")
UI:WaitShowDialogue("(This might be tougher than I thought...)")

GROUND:CharSetAnim(player, "Rotate", false)
GROUND:EntTurn(player, Direction.Right)

GAME:WaitFrames(20)

UI:SetSpeakerEmotion("Determined")
UI:WaitShowDialogue("(But I can't give up just yet! [pause=0]I have to try again!)")

SV.dungeons.drenchedbluff_fail = false
GROUND:Unhide('LeaveTown')
GAME:CutsceneMode(false)
end

function treasuretowncrossroads.BumpIntoEachother_Sequence(character) --God help us if I got to animate the two MANUALLY. / Least you don't have to animate this manually.
GROUND:MoveToPosition(character, 050, 181, false, 1)
end

function treasuretowncrossroads.ElectraterWalkIn_Sequence(character)
GROUND:MoveInDirection(character, Direction.Right, 30, true, 2)
end

function treasuretowncrossroads.ElectraterWalkIn2_Sequence(character) --Depreciated.
GROUND:MoveInDirection(character, Direction.Right, 200, false, 3)
end

function treasuretowncrossroads.PlayerTurn_Sequence(character) --I had trouble with this one.
GROUND:CharAnimateTurnTo(character, Direction.Right, 20) --For whatever reason, this one works fine, but with no Clockwise check. CharAnimateTurn doesn't. It hasn't been labeled as a bug since the time of writing this. / Was this even fixed? I haven't been checking patches.
end

function treasuretowncrossroads.ElectraterWalkIn3_Sequence(character) --Depreciated. / Used to end the Cutscene here.
GROUND:MoveInDirection(character, Direction.Right, 150, false, 3)
end

function treasuretowncrossroads.Smoliv_Action(chara, activator)
local player = CH('PLAYER')
GROUND:CharTurnToChar(chara, player)

UI:SetSpeaker(chara)
UI:SetSpeakerEmotion("Normal")
UI:WaitShowDialogue("I don't like the beach, [pause=10]it just smells too salty for me.")

end

function treasuretowncrossroads.Slaking_Action(chara, activator)

GROUND:CharTurnToChar(chara, activator)

UI:SetSpeaker(chara)
UI:SetSpeakerEmotion("Normal")
UI:WaitShowDialogue("My friend says he's over in [color=#FFC663]Treasure Town[color]...")
UI:WaitShowDialogue("He wanted me to go join him... [pause=20]But I just said... [pause=20]uh...")
UI:WaitShowDialogue(".[pause=15].[pause=15]. [pause=15].[pause=15].[pause=15]. [pause=15].[pause=15].[pause=15].") --Slowest thonk of the west.
UI:WaitShowDialogue("Nah... [pause=20]I'd rather sit here and do nothing, [pause=10]to be honest with you...")

end

function treasuretowncrossroads.Madilyn_Action(chara, activator)
local player = CH('PLAYER')
local chara = CH('Madilyn')

GROUND:CharTurnToChar(chara, player)

UI:SetSpeaker(chara)
UI:SetSpeakerEmotion("Normal")

local teamcount = GAME:GetPlayerPartyCount()

if teamcount >= 2 then --Surprising that this doesn't do the computer thing and check 0.

UI:WaitShowDialogue("Your friends can't come along, [pause=10]they're gonna have to find something else to do while we get this done.")
UI:WaitShowDialogue("Now...")

end

UI:ChoiceMenuYesNo("Are you ready to do your escorting job?", false)
UI:WaitForChoice()
ch = UI:ChoiceResult()
if ch then
    UI:WaitShowDialogue("About time...")
    UI:WaitShowDialogue("I'll get [color=#00FFFF]Kecleon[color] ready, [pause=10]and then we can get this done and over with.")
	
	GAME:SetCanRecruit(false)

	local party_table = GAME:GetPlayerPartyTable()
	-- check for presence
	local in_party = false
	for ii = 1, #party_table, 1 do
	  local ent = party_table[ii]
	  if ent.IsFounder then
	    in_party = true
		break
	  end
	end
	
	-- if no, search assembly and then add to party
	if not in_party then
	  local assemblyCount = GAME:GetPlayerAssemblyCount()
  
      for i = assemblyCount,1,-1 do
        p = GAME:GetPlayerAssemblyMember(i-1)
		if p.IsFounder then
		  GAME:RemovePlayerAssembly(i-1)
		  GAME:AddPlayerTeam(p)
		end
      end
	end
	
	-- move everyone else into assembly
	local partyCount = GAME:GetPlayerPartyCount()
    for i = partyCount,1,-1 do
      p = GAME:GetPlayerPartyMember(i-1)
	  if not p.IsFounder then
		GAME:RemovePlayerTeam(i-1)
		GAME:AddPlayerAssembly(p)
	  end
    end
	

	GAME:SetTeamLeaderIndex(0)
    COMMON.RespawnAllies()

	local mon_id = RogueEssence.Dungeon.MonsterID("kecleon", 0, "normal", Gender.Male)
	local kecleon = _DATA.Save.ActiveTeam:CreatePlayer(_DATA.Save.Rand, mon_id, 5, "color_change", 0)
	kecleon.Discriminator = _DATA.Save.Rand:Next()--tbh idk what this is lol
	kecleon.Level = 15
	kecleon.Nickname = 'Kecleon'
	kecleon.IsPartner = true-- if they somehow manage to die, end the run / Thanks Palika.
	
	kecleon.MaxHPBonus = 10
	kecleon.AtkBonus = 0
	kecleon.DefBonus = 0
	kecleon.MDefBonus = 0
	kecleon.SpeedBonus = 0

	kecleon:ReplaceSkill("feint", 0, false)
	kecleon:ReplaceSkill("fury_swipes", 1, true)
	kecleon:ReplaceSkill("shadow_sneak", 2, true) --Causes problems because he's too aggressive lol / Feint and Shadow Sneak act the exact same, his aggressiveness has not changed.
	kecleon:ReplaceSkill("bind", 3, true) --Despite everything, this move is actually useful.
	
	GAME:AddPlayerGuest(kecleon)
	kecleon:FullRestore()
	--kecleon.Tactic = _DATA:GetAITactic("escortee") --Avoid Trouble? More like cause trouble. What a joke of an AI.
    
	local talk_evt = RogueEssence.Dungeon.BattleScriptEvent("KecleonInteract")
    kecleon.ActionEvents:Add(talk_evt)
	kecleon:RefreshTraits()

	local mon_id = RogueEssence.Dungeon.MonsterID("piplup", 1, "normal", Gender.Female)
	local madilyn = _DATA.Save.ActiveTeam:CreatePlayer(_DATA.Save.Rand, mon_id, 5, "defiant", 0) --This is a real Ability Piplup has, look it up.
	madilyn.Discriminator = _DATA.Save.Rand:Next()--tbh idk what this is lol
	madilyn.Level = 30 --NOT CANON NUMBER. She's much stronger than the Player is, and always will be. This is the only thing I can think of for balancing reasons.
	madilyn.Nickname = 'Madilyn'
	madilyn.IsPartner = true -- if they somehow manage to die, end the run / Thanks Palika.
	
	madilyn.MaxHPBonus = 0
	madilyn.AtkBonus = 0
	madilyn.DefBonus = 0
	madilyn.MDefBonus = 0
	madilyn.SpeedBonus = 0

	madilyn:ReplaceSkill("brick_break", 0, true)
	madilyn:ReplaceSkill("aerial_ace", 1, true)
	madilyn:ReplaceSkill("bubble", 2, true)
	madilyn:ReplaceSkill("protect", 3, false)
	
	GAME:AddPlayerGuest(madilyn)
	madilyn:FullRestore() --What does this function do...? / Restores their Stats so they don't appear with 0 HP.
	
	madilyn.Tactic = _DATA:GetAITactic("go_after_foes") -- Sunkern helped here. / Apparently, she's too OP.
     
	local talk_evt = RogueEssence.Dungeon.BattleScriptEvent("MadilynInteract")
    madilyn.ActionEvents:Add(talk_evt)
	--madilyn.SilentEquipItem(seed_reviver) --No idea how I make this work.
	madilyn:RefreshTraits()
	SOUND:PlayBGM("None", true)
	
	GAME:WaitFrames(10)
	GAME:FadeOut(false, 30)
	
	if not SV.chapter1.road_to_crumble_cutscene then --If the player hasn't completed this cutscene, go to this segment.
	GAME:WaitFrames(60)
	GAME:EnterZone('cutscenezone', -1, 4, 0)
	else --if they have, go to the dungeon instead.
	GAME:WaitFrames(20)
	GAME:EnterDungeon('roadwalkpathway', 0, 0, 0, RogueEssence.Data.GameProgress.DungeonStakes.Risk, true, true)
	end
	
else
    UI:WaitShowDialogue("Then hurry up, [pause=10]I'm not standing here all day.")
end

end

function treasuretowncrossroads.chapterhidescript()
GROUND:Hide("AdamMudkip")
GROUND:Hide("Madilyn")

if SV.chapter.number == 0 then

GROUND:Hide("Smoliv")
GROUND:Hide("Slaking")

elseif SV.chapter.number == 1 then

--Add more npcs later.

if SV.chapter1.meeting_partB == true then
GROUND:Unhide("Madilyn")
end

else --nothing

end

end

return treasuretowncrossroads

