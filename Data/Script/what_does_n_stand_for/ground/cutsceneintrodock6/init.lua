--[[
    init.lua
    Created: 06/06/2024 20:35:33
    Description: Autogenerated script file for the map cutsceneintrodock6.
]]--
-- Commonly included lua functions and data
require 'what_does_n_stand_for.common'

-- Package name
local cutsceneintrodock6 = {}

-- Local, localized strings table
-- Use this to display the named strings you added in the strings files for the map!
-- Ex:
--      local localizedstring = STRINGS.MapStrings['SomeStringName']


-------------------------------
-- Map Callbacks
-------------------------------
---cutsceneintrodock6.Init(map)
--Engine callback function
function cutsceneintrodock6.Init(map)

  --This will fill the localized strings table automatically based on the locale the game is 
  -- currently in. You can use the MapStrings table after this line!
  

end

---cutsceneintrodock6.Enter(map)
--Engine callback function
function cutsceneintrodock6.Enter(map)

StoryMoment()

end

---cutsceneintrodock6.Exit(map)
--Engine callback function
function cutsceneintrodock6.Exit(map)

SOUND:FadeOutSE("Beach_Noise", 20) --Mostly a precaution.

end

---cutsceneintrodock6.Update(map)
--Engine callback function
function cutsceneintrodock6.Update(map)


end

---cutsceneintrodock6.GameSave(map)
--Engine callback function
function cutsceneintrodock6.GameSave(map)


end

---cutsceneintrodock6.GameLoad(map)
--Engine callback function
function cutsceneintrodock6.GameLoad(map)

  GAME:FadeIn(20)

end

-------------------------------
-- Entities Callbacks
-------------------------------

function StoryMoment()
local player = CH('PLAYER')
local Magnezone = CH('Magnezone')
local LaprasParticleLoop = false
local LaprasBobLoop = false --Once the ParticleLoop Variable finishes, this lets the player jump onto Lapras without it softlocking. Probably a better solution somewhere.
local Lapras = CH('Lapras')

GAME:CutsceneMode(true)
GAME:MoveCamera(238, 301, 1, false)
GAME:WaitFrames(10)

GROUND:CharSetAnim(Lapras, "Idle", true)

local coro3 = TASK:BranchCoroutine(function() --This should not work, it's a really stupid place for a coro, but if it gets Lapras moving before the Screen fades in, then whatever.

while not LaprasParticleLoop do
LaprasBobLoop = false
LaprasWaterBob()
LaprasBobLoop = true
end

end)

GAME:WaitFrames(10)

local coro1 = TASK:BranchCoroutine(function()
GROUND:MoveInDirection(player, Direction.Down, 60, false, 1)
end)

local coro2 = TASK:BranchCoroutine(function()
GAME:FadeIn(20)
end)

SOUND:FadeInSE("Beach_Noise")
TASK:JoinCoroutines({coro1, coro2})

SOUND:PlayBattleSE("EVT_Emote_Confused")
GROUND:CharSetEmote(player, "question", 1)
GAME:WaitFrames(40)

SOUND:PlayBattleSE("EVT_Emote_Confused")
GROUND:EntTurn(player, Direction.DownLeft)
GAME:WaitFrames(30)

GROUND:CharAnimateTurn(player, Direction.DownRight, 6, true)
SOUND:PlayBattleSE("EVT_Emote_Confused")
GAME:WaitFrames(30)

GROUND:EntTurn(player, Direction.Down)
GAME:WaitFrames(40)

SOUND:PlayBattleSE("EVT_Emote_Sweatdrop")
GROUND:CharSetEmote(player, "sweatdrop", 1)
GAME:WaitFrames(40)

UI:SetSpeaker(player, false)
UI:SetSpeakerEmotion("Worried")
UI:WaitShowDialogue("(That's... [pause=20]odd. [pause=0]There's a lot more law enforcement here than usual.)")
UI:WaitShowDialogue("([color=#FFC663]Lively Town[color] in the east is a much more popular port than this western one is...)")
UI:WaitShowDialogue("(...Ah, [pause=10]whatever. [pause=0]I have a [color=#32a852]Passport[color] with a stamp for the [color=#FFC663]Sky Region[color]. [pause=0]I'll be fine.)")

coro1 = TASK:BranchCoroutine(function()
GROUND:MoveInDirection(player, Direction.Down, 60, false, 1)
SOUND:PlayBattleSE("EVT_Emote_Startled")
GROUND:CharSetAnim(player, "Hurt", false)
GAME:WaitFrames(15)
GROUND:EntTurn(player, Direction.DownLeft)
end)

coro2 = TASK:BranchCoroutine(function()
GAME:WaitFrames(30)
GROUND:EntTurn(Magnezone, Direction.UpRight)
end)

--TASK:JoinCoroutines({coro1,coro2})
GAME:WaitFrames(60)

UI:SetSpeaker(Magnezone)
UI:SetSpeakerEmotion("Normal")
UI:WaitShowDialogue("BZZT! [pause=20]TRAVELER, [pause=10]PLEASE CONFIRM THAT YOU HAVE A [color=#32a852]PASSPORT[color] AT THE READY.")

GROUND:MoveInDirection(player, Direction.DownLeft, 25, false, 1)
GROUND:MoveInDirection(player, Direction.Left, 5, false, 1)
GROUND:EntTurn(Magnezone, Direction.Right)
SOUND:PlayBattleSE("EVT_CH02_Item_Place")
GAME:WaitFrames(40)

UI:WaitShowDialogue("HM... [pause=20][color=#FFC663]SKY REGION[color] STAMP... [pause=20]NICKNAMED '".. CH('PLAYER'):GetDisplayName() .."'...")
UI:WaitShowDialogue("BRRZT! [pause=20]NO KNOWN CRIMINAL RECORD. [pause=0]YOU MAY HAVE THE [color=#32a852]PASSPORT[color] BACK.")
SOUND:PlayBattleSE("EVT_CH02_Item_Place")
UI:WaitShowDialogue("YOU ARE FREE TO RIDE THE [color=#00FFFF]LAPRAS[color] LINER. [pause=20]BZZT!")

GROUND:CharAnimateTurn(player, Direction.DownRight, 3, true)
GAME:WaitFrames(10)
GROUND:MoveInDirection(player, Direction.DownRight, 12, false, 1)
GROUND:MoveInDirection(player, Direction.Down, 40, false, 1)
GROUND:CharAnimateTurn(player, Direction.Right, 3, true)
GAME:WaitFrames(5)
GROUND:MoveInDirection(player, Direction.Right, 20, false, 1)

LaprasParticleLoop = true --Failsafe

while LaprasBobLoop == false do
GAME:WaitFrames(5)  --If it's false, wait until the while finishes before attempting to make the PC jump to avoid a hardsoftlock.
end

PlayerJump()

coro1 = TASK:BranchCoroutine(function() GROUND:AnimateInDirection(player, "None", Direction.Down, Direction.Down, 90, 3, 1) end)
coro2 = TASK:BranchCoroutine(function() GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Down, 90, 3, 1) end)
coro3 = TASK:BranchCoroutine(function() GAME:FadeOut(false, 60) end)

TASK:JoinCoroutines({coro1,coro2,coro3})

SOUND:FadeOutSE("Beach_Noise", 20)
GAME:WaitFrames(30)

GAME:CutsceneMode(false)

GAME:EnterGroundMap("cutsceneintrofinal7", "Entrance")

end

function LaprasWaterBob()
local Lapras = CH('Lapras')

	for i=1,10 do

		if i <= 5 then

  GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Up, 1, 3, 1)
  GAME:WaitFrames(i % 5 == 0 and 9 or 5)

		else

  GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Down, 1, 3, 1)
  GAME:WaitFrames(i % 5 == 0 and 9 or 5)

		end

	end

end

function PlayerJump()
local player = CH('PLAYER')
local Lapras = CH('Lapras')

GAME:WaitFrames(10)
GROUND:AnimateToPosition(player, "Hop", Direction.Right, 305, 360, 1, 2, 1)
GAME:WaitFrames(1)

local coro1 = TASK:BranchCoroutine(function()

for i=1,6 do

GROUND:AnimateInDirection(player, "None", Direction.Right, Direction.Down, i % 2 == 0 and 1 or 3, 3, 1)
--GROUND:AnimateInDirection(player, "None", Direction.Right, Direction.Down, 1, 3, 1)
GROUND:AnimateInDirection(player, "None", Direction.Right, Direction.Up, i % 4 == 0 and 1 or 3, 3, 1)
--GROUND:AnimateInDirection(player, "None", Direction.Right, Direction.Up, 1, 3, 1)

end

end)

local coro2 = TASK:BranchCoroutine(function()

for p=1,6 do

GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Down, p % 2 == 0 and 1 or 3, 3, 1)
--GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Down, 1, 3, 1)
GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Up, p % 4 == 0 and 1 or 3, 3, 1)
--GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Up, 1, 3, 1)

end

end)

TASK:JoinCoroutines({coro1,coro2})

GROUND:CharAnimateTurn(player, Direction.Down, 3, false)
GAME:WaitFrames(5)

coro1 = TASK:BranchCoroutine(function()

GROUND:AnimateInDirection(player, "None", Direction.Down, Direction.Down, 2, 3, 1)

end)

coro2 = TASK:BranchCoroutine(function()

GROUND:AnimateInDirection(Lapras, "None", Direction.Down, Direction.Down, 2, 3, 1)

end)

TASK:JoinCoroutines({coro1,coro2})

end

return cutsceneintrodock6
